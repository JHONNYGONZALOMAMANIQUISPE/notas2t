<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üìä Evaluaci√≥n Integral</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    input[type="number"] { width: 60px; }
    input[type="text"] { width: 100px; }
    .hidden { display: none; }
    .btn { margin: 5px; padding: 8px 12px; border: none; background: #4285f4; color: #fff; cursor: pointer; border-radius: 4px; }
    .btn:hover { background: #3367d6; }
    .section { margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>üìò Sistema de Evaluaci√≥n Integral</h2>

  <!-- LOGIN -->
  <div id="loginSection" class="section">
    <h3>üîë Ingreso Administrador</h3>
    <input type="password" id="adminPass" placeholder="Contrase√±a">
    <button class="btn" onclick="login()">Ingresar</button>
  </div>

  <!-- ADMIN -->
  <div id="adminSection" class="section hidden">
    <h3>üë®‚Äçüíº Panel Administrador</h3>

    <!-- A√±adir estudiante -->
    <h4>A√±adir estudiante manualmente</h4>
    C√≥digo: <input type="text" id="codigo">
    Nombre: <input type="text" id="nombre">
    <button class="btn" onclick="addEstudiante()">A√±adir</button>

    <!-- Cargar CSV -->
    <h4>Cargar estudiantes v√≠a CSV</h4>
    <input type="file" id="csvFile" accept=".csv" onchange="loadCSV(event)">

    <!-- Gesti√≥n de subcriterios -->
    <h4>A√±adir subcriterio a dimensi√≥n</h4>
    Dimensi√≥n:
    <select id="dimSelect">
      <option value="ser">SER</option>
      <option value="saber">SABER</option>
      <option value="hacer">HACER</option>
      <option value="decidir">DECIDIR</option>
    </select>
    Nombre subcriterio: <input type="text" id="subInput">
    <button class="btn" onclick="addSubcriterio()">A√±adir Subcriterio</button>

    <!-- Importar / Exportar CSV -->
    <h4>Importar / Exportar Notas</h4>
    <button class="btn" onclick="exportCSV()">‚¨áÔ∏è Descargar plantilla CSV</button>
    <input type="file" id="uploadCSV" accept=".csv" onchange="importCSV(event)">
  </div>

  <!-- NOTAS -->
  <div id="notasSection" class="section hidden">
    <h3>üìä Registro de Notas</h3>
    <table id="tablaNotas">
      <thead>
        <tr id="headerRow">
          <th>C√≥digo</th>
          <th>Nombre</th>
          <!-- Subcriterios se insertar√°n din√°micamente -->
          <th>Autoevaluaci√≥n</th>
          <th>Extras</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const password = "1234"; // Cambiar contrase√±a del admin
    let estudiantes = [];
    let subcriterios = { ser: ["Ser_1","Ser_2"], saber: ["Saber_1","Saber_2"], hacer: ["Hacer_1","Hacer_2"], decidir: ["Decidir_1","Decidir_2"] };

    function login() {
      if (document.getElementById("adminPass").value === password) {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("adminSection").classList.remove("hidden");
        document.getElementById("notasSection").classList.remove("hidden");
        renderNotas();
      } else {
        alert("‚ùå Contrase√±a incorrecta");
      }
    }

    function addEstudiante() {
      const codigo = document.getElementById("codigo").value.trim();
      const nombre = document.getElementById("nombre").value.trim();
      if(!codigo || !nombre){ alert("C√≥digo y nombre obligatorios"); return; }
      estudiantes.push({ codigo, nombre, notas: inicializarNotas() });
      renderNotas();
    }

    function inicializarNotas() {
      let notas = { auto:0, extras:0 };
      for (let dim in subcriterios) notas[dim] = subcriterios[dim].map(()=>0);
      return notas;
    }

    function addSubcriterio() {
      const dim = document.getElementById("dimSelect").value;
      const sub = document.getElementById("subInput").value.trim();
      if(!sub) return;
      subcriterios[dim].push(sub);
      estudiantes.forEach(est => est.notas[dim].push(0));
      document.getElementById("subInput").value="";
      renderNotas();
    }

    function renderNotas() {
      // Headers
      const headerRow = document.getElementById("headerRow");
      headerRow.innerHTML = "<th>C√≥digo</th><th>Nombre</th>";
      for (let dim in subcriterios){
        subcriterios[dim].forEach(sub => headerRow.innerHTML += `<th>${dim.toUpperCase()}:${sub}</th>`);
        headerRow.innerHTML += `<th>Promedio ${dim.toUpperCase()}</th>`;
      }
      headerRow.innerHTML += "<th>Autoevaluaci√≥n</th><th>Extras</th><th>Total</th>";

      const tbody = document.querySelector("#tablaNotas tbody");
      tbody.innerHTML = "";
      estudiantes.forEach((est,index)=>{
        let row = `<tr><td>${est.codigo}</td><td>${est.nombre}</td>`;
        let total=0;
        for(let dim in subcriterios){
          let sum=0;
          subcriterios[dim].forEach((sub,i)=>{
            row+=`<td><input type="number" min="0" max="25" value="${est.notas[dim][i]}" 
                  onchange="updateNota(${index},'${dim}',${i},this.value)"></td>`;
            sum+=est.notas[dim][i];
          });
          let prom=sum/subcriterios[dim].length;
          row+=`<td>${prom.toFixed(2)}</td>`;
          total+=prom;
        }
        row+=`<td><input type="number" min="0" max="5" value="${est.notas.auto}" onchange="updateAuto(${index},this.value)"></td>`;
        row+=`<td><input type="number" min="0" value="${est.notas.extras}" onchange="updateExtras(${index},this.value)"></td>`;
        total+=est.notas.auto + est.notas.extras;
        row+=`<td>${total.toFixed(2)}</td></tr>`;
        tbody.innerHTML += row;
      });
    }

    function updateNota(index, dim, i, val){ estudiantes[index].notas[dim][i]=Number(val); renderNotas(); }
    function updateAuto(index,val){ estudiantes[index].notas.auto=Number(val); renderNotas(); }
    function updateExtras(index,val){ estudiantes[index].notas.extras=Number(val); renderNotas(); }

    function loadCSV(event){
      const file = event.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        const rows = e.target.result.split("\n").map(r=>r.split(","));
        rows.forEach(row=>{
          if(row.length>=2) estudiantes.push({codigo: row[0].trim(), nombre: row[1].trim(), notas: inicializarNotas()});
        });
        renderNotas();
      };
      reader.readAsText(file);
    }

    function exportCSV(){
      let csv = "Codigo,Nombre";
      for(let dim in subcriterios) subcriterios[dim].forEach(sub=>csv+=","+sub);
      csv+=",Autoevaluacion,Extras\n";
      estudiantes.forEach(est=>{
        let line = `${est.codigo},${est.nombre}`;
        for(let dim in subcriterios) line+=","+est.notas[dim].join(",");
        line+=","+est.notas.auto+","+est.notas.extras;
        csv+=line+"\n";
      });
      const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url; link.download="notas.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function importCSV(event){
      const file = event.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        const rows = e.target.result.split("\n").map(r=>r.split(","));
        rows.shift();
        rows.forEach(row=>{
          if(row.length<2) return;
          const est = estudiantes.find(s=>s.codigo===row[0].trim());
          if(est){
            let col=2;
            for(let dim in subcriterios){
              est.notas[dim]=subcriterios[dim].map(()=>Number(row[col++]||0));
            }
            est.notas.auto=Number(row[col++]||0);
            est.notas.extras=Number(row[col++]||0);
          }
        });
        renderNotas();
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
